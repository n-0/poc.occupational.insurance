---
title: "poc.occupation.insurance"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{pococcupationinsurance}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(poc.occupational.insurance)
```

## Introduction
poc.occupational.insurance is a proof of concept (poc) 
of how to use a simple 3 state Markov model to price unemployment insurance
and estimate prediction models based on data. By Definition one should 
use this not directly but rather built actual implementations on top of it.

## Pricing
For starters, one probably has done some population survey at the start and end
of some year, during which a certain cohort was asked if they were currently employed
or are currently not able to search for such a position. To save yourself from the hassle,
finding enough people on the street, asking them and storing responsibly in accord with GDPR
their data, this package comes preincluded with a sample data set, which also highlights
the format which is expected from the data.
You can load it via its name:
```{r}
icdf = occupation1977stlouis;
```
To directly compute the one-period transition probabilites, you can use:
```{r}
probs = determine_probs(icdf);
```
This data is of course not smooth and if there's a specific reason for a certain 
age group not to work or to reenter the workforce (e.g. due to changes in the retirement age by law)
you might want to smooth this data. An estimation procedure is included in this package, which 
we will describe later on.
For now we will create our `3x3` one period transition matrices:
```{r}
matrix_20_1 = transition_matrix_x(20, probs)
```
As usual for Markov matrices the rows sum up to $1$. Each row stands for the current state 
an individual is in and the column the probability to transition into the corresponding state
during one period. In this case the dimension correspond to `active`, `inactive`, `death`
shortened to `a`,`i`,`d` respectively.
As usual one can compute then the Markov matrices after $t$ periods starting from age $x$
from the one period matrices $P_x$ via:
$$
P_x(t) = \prod_{i=0}^t P_{x+i}.
$$

As a convenience tool that you don't have to write this each time yourself you can use:
```{r}
matrix_20_3 = transition_matrix_x_t(20, 3, probs)
```
Both of these functions also accept vectors as their inputs, meaning
```{r}
matrix_20_3 = transition_matrix_x_t(20, (1:3), probs)
```
will result in a `data.frame` with a row for each $P_x(t)$ with $t \in \{ 1, 2, 3 \}$.

To compute the one time premium for $5$-year policy  
paying out $200$ monetary units at the end of each period in case of unemployment under the assumption of $1\%$ actuarial interest, 
starting with an individual, which is currently `active` and of age $20$, you can use
```{r}
one_time_premium = occupation_insurance_one_time_premium(20, 5, 200, 0.01, probs)
```

For the more natural premia paid in advance but only for a specific time period less than the policy duration (e.g. $2$), one can use
```{r}
matrix_20_3 = occupation_insurance_recurrent_premium(20, 5, 200, 0.01, probs, 2)
```
Last one can also determine the reserve, which looks particularly nice with plots

```{r}
example_of_reserve_plot = function() {
    transition_probs = determine_probs(occupation1977stlouis)
    duration = 20 
    benefit = 500
    premium_duration = 5
    v = 1/1.03
    x = 30
    ts = c(0:(duration-1))
    active_reserve = sapply(ts, function(t) occupation_insurance_recurrent_reserve(
         t, x, duration, benefit, v, transition_probs, active=TRUE, opt_premium_duration=premium_duration
         )
    )
    barplot(active_reserve)
    active_reserve
}
example_of_reserve_plot()
```
## Model estimation
This package offers a way to model for smaller age intervals smoothly the transition matrices based on observed transitions.
The approach taking is quite general, namely using [softmax regression](http://deeplearning.stanford.edu/tutorial/supervised/SoftmaxRegression/).

In our case this means that for a given starting age $x$ and state $a$ during $t$-periods the probability of transitioning into state $i$ is given by
$$
P_{a,i}(t) = \frac{e^{\beta_{1,a,i} t + \beta_{0,a,i}}}{\sum_{k \in S} e^{\beta_{1,a,k} t + \beta_{0,a,k}} }
$$
where $S$ is the set of all avaible states ($\{ a, i, d\}$).
With the help of maximum likelihood estimation, we can model from our survey the one period transitions:

```{r}
icdc_df_ext = extend_incdec_table(icdf);
est = max_l_softmax_estimate(icdc_df_ext, (20:24));
transition_matrix_from_est(est, 1)
```
Of course `est` contains only the estimated parameters, so to put them into an actual matrix the last call is necessary.

If you find yourself wondering what the purpose of some argument of a function is, there are also individual
docs available e.g. calling `?transition_matrix_from_est`.
